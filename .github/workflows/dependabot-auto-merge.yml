name: Dependabot Auto-Merge with Cooldown

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]
  schedule:
    # Check daily for PRs that have passed cooldown period
    - cron: '0 3 * * *'

permissions:
  contents: write
  pull-requests: write
  issues: read

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]' || github.event_name == 'schedule'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v1
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"
        continue-on-error: true
      
      - name: Check PR age and severity
        id: check
        if: github.event_name == 'pull_request'
        run: |
          PR_URL="${{ github.event.pull_request.html_url }}"
          CREATED_AT="${{ github.event.pull_request.created_at }}"
          SEVERITY="${{ steps.metadata.outputs.severity }}"
          ALERT_STATE="${{ steps.metadata.outputs.alert-state }}"
          
          # Calculate PR age in days
          if [ -n "$CREATED_AT" ]; then
            PR_DATE=$(date -d "$CREATED_AT" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$CREATED_AT" +%s)
            CURRENT_DATE=$(date +%s)
            DAYS_OLD=$(( ($CURRENT_DATE - $PR_DATE) / 86400 ))
          else
            DAYS_OLD=0
          fi
          
          echo "days_old=$DAYS_OLD" >> $GITHUB_OUTPUT
          echo "severity=${SEVERITY:-none}" >> $GITHUB_OUTPUT
          echo "alert_state=${ALERT_STATE:-none}" >> $GITHUB_OUTPUT
          
          # Determine if should auto-merge
          SHOULD_MERGE="false"
          REASON=""
          
          # Auto-merge critical or high severity security fixes immediately
          if [[ "$ALERT_STATE" == "FIXED" ]] && [[ "$SEVERITY" == "critical" || "$SEVERITY" == "high" ]]; then
            SHOULD_MERGE="true"
            REASON="ðŸš¨ Critical or high severity security fix - merging immediately"
          # For medium/low severity or non-security updates, enforce 14-day cooldown
          elif [[ $DAYS_OLD -ge 14 ]]; then
            SHOULD_MERGE="true"
            REASON="âœ… Cooldown period passed (${DAYS_OLD} days old, >= 14 days required)"
          else
            SHOULD_MERGE="false"
            DAYS_REMAINING=$((14 - DAYS_OLD))
            REASON="â±ï¸ In cooldown period (${DAYS_OLD} days old, ${DAYS_REMAINING} days remaining)"
          fi
          
          echo "should_merge=$SHOULD_MERGE" >> $GITHUB_OUTPUT
          echo "reason=$REASON" >> $GITHUB_OUTPUT
          echo "days_remaining=$((14 - DAYS_OLD))" >> $GITHUB_OUTPUT
      
      - name: Auto-merge if criteria met
        if: |
          github.event_name == 'pull_request' &&
          steps.check.outputs.should_merge == 'true'
        run: |
          gh pr comment "$PR_URL" --body "${{ steps.check.outputs.reason }}
          
          **Auto-merge criteria met:**
          - Severity: ${{ steps.check.outputs.severity }}
          - Alert State: ${{ steps.check.outputs.alert_state }}
          - PR Age: ${{ steps.check.outputs.days_old }} days
          
          Enabling auto-merge..."
          
          # Enable auto-merge with squash
          gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Add cooldown label and comment
        if: |
          github.event_name == 'pull_request' &&
          steps.check.outputs.should_merge == 'false' && 
          !contains(github.event.pull_request.labels.*.name, 'cooldown-active')
        run: |
          gh pr comment "$PR_URL" --body "${{ steps.check.outputs.reason }}
          
          **Cooldown Period Active:**
          - **Severity:** ${{ steps.check.outputs.severity }}
          - **PR Age:** ${{ steps.check.outputs.days_old }} days
          - **Days Remaining:** ${{ steps.check.outputs.days_remaining }}
          - **Policy:** Non-critical updates require 14-day cooldown for community vetting
          
          This PR will be automatically reviewed again and merged after the cooldown period expires.
          
          You can manually merge this PR at any time if needed."
          
          gh pr edit "$PR_URL" --add-label "cooldown-active"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Check all open Dependabot PRs (scheduled run)
        if: github.event_name == 'schedule'
        continue-on-error: true
        run: |
          echo "Checking all open Dependabot PRs for cooldown expiration..."
          
          # Get all open PRs from Dependabot
          PRS=$(gh pr list --author "dependabot[bot]" --json number,url,createdAt,labels --limit 50)
          
          if [ -z "$PRS" ] || [ "$PRS" == "[]" ]; then
            echo "âœ… No open Dependabot PRs found. Nothing to process."
            exit 0
          fi
          
          echo "$PRS" | jq -r '.[] | select(.labels[].name == "cooldown-active") | .url' | \
            while read PR_URL; do
              if [ -n "$PR_URL" ]; then
                echo "Re-triggering workflow for: $PR_URL"
                # Trigger workflow by adding a comment
                gh pr comment "$PR_URL" --body "ðŸ”„ Daily cooldown check..." || true
              fi
            done
          
          echo "âœ… Scheduled check complete."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

